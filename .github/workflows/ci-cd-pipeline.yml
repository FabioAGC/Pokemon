name: CI/CD Pipeline - Pokemon Project

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  MAVEN_OPTS: -Xmx1024m
  JAVA_VERSION: '11'

jobs:
  # Job 1: Testes UnitÃ¡rios e Mock
  test:
    name: ğŸ§ª Executar Testes
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: â˜• Configurar Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: ğŸ“¦ Cache das dependÃªncias Maven
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: ğŸ”§ Instalar dependÃªncias e compilar
      run: |
        echo "ğŸ”§ Instalando dependÃªncias Maven..."
        mvn clean compile test-compile
        
    - name: ğŸ§ª Executar testes unitÃ¡rios
      run: |
        echo "ğŸ§ª Executando testes unitÃ¡rios e de mock..."
        mvn test
        
    - name: ğŸ“Š Processar resultados dos testes
      id: test-results
      run: |
        echo "ğŸ“Š Processando resultados dos testes..."
        
        # Contar testes executados
        if [ -f target/surefire-reports/TEST-*.xml ]; then
          TEST_COUNT=$(grep -o 'tests="[0-9]*"' target/surefire-reports/TEST-*.xml | grep -o '[0-9]*' | head -1)
          TEST_PASSED=$(grep -o 'failures="0" errors="0"' target/surefire-reports/TEST-*.xml | wc -l)
          TEST_FAILED=$((TEST_COUNT - TEST_PASSED))
        else
          TEST_COUNT=0
          TEST_PASSED=0
          TEST_FAILED=0
        fi
        
        echo "TEST_COUNT=$TEST_COUNT" >> $GITHUB_ENV
        echo "TEST_PASSED=$TEST_PASSED" >> $GITHUB_ENV
        echo "TEST_FAILED=$TEST_FAILED" >> $GITHUB_ENV
        
        # Outputs para outros jobs
        echo "test_count=$TEST_COUNT" >> $GITHUB_OUTPUT
        echo "test_passed=$TEST_PASSED" >> $GITHUB_OUTPUT
        echo "test_failed=$TEST_FAILED" >> $GITHUB_OUTPUT
        
        if [ $TEST_FAILED -eq 0 ]; then
          echo "TEST_STATUS=SUCCESS" >> $GITHUB_ENV
          echo "test_status=SUCCESS" >> $GITHUB_OUTPUT
          echo "âœ… Todos os testes passaram!"
        else
          echo "TEST_STATUS=FAILURE" >> $GITHUB_ENV
          echo "test_status=FAILURE" >> $GITHUB_OUTPUT
          echo "âŒ Alguns testes falharam!"
        fi
        
    - name: ğŸ“ Upload relatÃ³rio de testes
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-reports
        path: target/surefire-reports/
        retention-days: 30
        
    - name: ğŸ“‹ Exibir resumo dos testes
      run: |
        echo "ğŸ“‹ Resumo dos Testes:"
        echo "â€¢ Total de testes: $TEST_COUNT"
        echo "â€¢ Testes passaram: $TEST_PASSED"
        echo "â€¢ Testes falharam: $TEST_FAILED"
        echo "â€¢ Status: $TEST_STATUS"

  # Job 2: Build e Empacotamento (roda em paralelo com os testes)
  build:
    name: ğŸ“¦ Build e Empacotamento
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: â˜• Configurar Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: ğŸ“¦ Cache das dependÃªncias Maven
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: ğŸ”§ Compilar projeto
      run: |
        echo "ğŸ”§ Compilando projeto..."
        mvn clean compile
        
    - name: ğŸ“¦ Criar pacote JAR
      run: |
        echo "ğŸ“¦ Criando pacote JAR..."
        mvn package -DskipTests
        
    - name: ğŸ“Š Verificar artefatos gerados
      run: |
        echo "ğŸ“Š Verificando artefatos gerados..."
        ls -la target/
        
        if [ -f target/pokemon-do-dia-*.jar ]; then
          echo "BUILD_STATUS=SUCCESS" >> $GITHUB_ENV
          echo "âœ… JAR criado com sucesso!"
          JAR_SIZE=$(du -h target/pokemon-do-dia-*.jar | cut -f1)
          echo "ğŸ“¦ Tamanho do JAR: $JAR_SIZE"
        else
          echo "BUILD_STATUS=FAILURE" >> $GITHUB_ENV
          echo "âŒ Falha ao criar JAR!"
          exit 1
        fi
        
    - name: ğŸ“ Upload JAR executÃ¡vel
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: pokemon-jar
        path: target/pokemon-do-dia-*.jar
        retention-days: 30
        
    - name: ğŸ“ Upload JAR com dependÃªncias
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: pokemon-fat-jar
        path: target/pokemon-do-dia-*-shaded.jar
        retention-days: 30

  # Job 3: NotificaÃ§Ã£o por Email
  notification:
    name: ğŸ“§ Enviar NotificaÃ§Ã£o
    runs-on: ubuntu-latest
    needs: [test, build]
    if: always()  # Executa mesmo se outros jobs falharem
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“§ Instalar dependÃªncias Python
      run: |
        echo "ğŸ“§ Instalando dependÃªncias Python..."
        # Python jÃ¡ tem smtplib e email built-in, nÃ£o precisa instalar nada
        
    - name: ğŸ”§ Tornar script executÃ¡vel
      run: |
        echo "ğŸ”§ Tornando script executÃ¡vel..."
        chmod +x scripts/send_notification.py
        
    - name: ğŸ“§ Enviar notificaÃ§Ã£o por email
      env:
        NOTIFICATION_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}
        SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        TEST_STATUS: ${{ needs.test.result }}
        BUILD_STATUS: ${{ needs.build.result }}
        TEST_COUNT: ${{ needs.test.outputs.test_count }}
        TEST_PASSED: ${{ needs.test.outputs.test_passed }}
        TEST_FAILED: ${{ needs.test.outputs.test_failed }}
        POM_VERSION: ${{ github.ref_name }}
      run: |
        echo "ğŸ“§ Enviando notificaÃ§Ã£o por email..."
        python3 scripts/send_notification.py
        
    - name: ğŸ“‹ Exibir status final
      run: |
        echo "ğŸ“‹ Status Final do Pipeline:"
        echo "â€¢ Testes: ${{ needs.test.result }}"
        echo "â€¢ Build: ${{ needs.build.result }}"
        echo "â€¢ NotificaÃ§Ã£o: ${{ job.status }}"
        
        if [ "${{ needs.test.result }}" = "success" ] && [ "${{ needs.build.result }}" = "success" ]; then
          echo "ğŸ‰ Pipeline concluÃ­do com sucesso!"
        else
          echo "âŒ Pipeline falhou em alguma etapa!"
        fi

  # Job 4: Deploy (opcional - roda apenas em main)
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main' && needs.test.result == 'success' && needs.build.result == 'success'
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download artefatos
      uses: actions/download-artifact@v3
      with:
        name: pokemon-jar
        path: ./artifacts/
        
    - name: ğŸš€ Simular deploy
      run: |
        echo "ğŸš€ Simulando deploy..."
        echo "ğŸ“¦ Artefatos prontos para deploy:"
        ls -la artifacts/
        echo "âœ… Deploy simulado concluÃ­do!"
